<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é£Ÿå…‰å°èˆª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --morandi-bg: #EAEAEA; --morandi-pink: #D4B2B0; --morandi-coffee: #8C7B6C;
            --morandi-slate: #7A8A99; --morandi-clay: #A99985; --morandi-text: #555555;
        }
        body { background-color: var(--morandi-bg); color: var(--morandi-text); font-family: "PingFang TC", sans-serif; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        .search-results { max-height: 250px; overflow-y: auto; border-radius: 1.5rem; background: white; border: none; position: absolute; z-index: 100; width: 100%; display: none; margin-top: 8px; box-shadow: 0 15px 30px rgba(0,0,0,0.08); }
        .search-item { padding: 16px; cursor: pointer; border-bottom: 1px solid #f2f2f2; font-size: 14px; color: var(--morandi-text); }
        .recent-label { padding: 10px 16px; font-size: 11px; color: var(--morandi-pink); background: #fafafa; font-weight: bold; letter-spacing: 2px; }
        .selected-chip { background-color: var(--morandi-pink); color: white; display: inline-flex; align-items: center; border-radius: 99px; padding: 6px 14px; font-size: 11px; margin: 4px; box-shadow: 0 4px 10px rgba(212, 178, 176, 0.3); }
        .selected-chip span { margin-left: 8px; cursor: pointer; font-size: 16px; line-height: 1; }
        .price-box { border: 1px solid #eee; background: white; padding: 10px 2px; border-radius: 15px; text-align: center; cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; justify-content: center; min-height: 55px; }
        .price-box.active { background: var(--morandi-slate); color: white; border-color: var(--morandi-slate); box-shadow: 0 8px 15px rgba(122, 138, 153, 0.2); }
        .page { transition: transform 0.4s ease-in-out, opacity 0.4s; position: absolute; width: 100%; min-height: 100vh; padding: 20px; }
        .hidden-page { transform: translateX(100%); opacity: 0; pointer-events: none; }
        .shop-card { animation: slideUp 0.5s ease-out forwards; opacity: 0; background: #FFFFFF; border-radius: 2.2rem; padding: 1.8rem; margin-bottom: 1.5rem; box-shadow: 0 10px 20px rgba(0,0,0,0.03); border: none; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .price-text { font-size: 13px; font-weight: 800; color: var(--morandi-clay); letter-spacing: 1px; }
        .input-style { width: 100%; padding: 16px; background: white; border-radius: 1.2rem; border: none; outline: none; font-size: 14px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.02); }
        .cat-tag { font-size: 10px; padding: 3px 12px; border-radius: 20px; font-weight: bold; display: inline-block; background: #F5F5F5; color: #999; margin-right: 6px; }
        .loader { border: 3px solid #eee; border-top: 3px solid var(--morandi-pink); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        #editModal, #backupModal { background: rgba(0,0,0,0.1); display: none; align-items: center; justify-content: center; z-index: 1000; position: fixed; inset: 0; backdrop-filter: blur(10px); }
    </style>
</head>
<body>

    <div class="max-w-md mx-auto relative">
        <div id="filterPage" class="page">
            <header class="flex justify-between items-center py-8">
                <div class="w-10"></div>
                <h1 class="text-2xl font-bold tracking-[0.4em] text-[var(--morandi-coffee)]">é£Ÿå…‰å°èˆª</h1>
                <button onclick="goToPocket()" class="text-[var(--morandi-pink)] font-bold text-xs bg-white px-4 py-2 rounded-full shadow-sm active:scale-90 transition-all">æˆ‘çš„æ”¶è—</button>
            </header>

            <div class="bg-white/70 backdrop-blur-xl rounded-[3rem] p-8 space-y-8">
                <div class="space-y-3 relative">
                    <label class="font-bold text-xs text-[var(--morandi-coffee)] px-1 tracking-widest uppercase">æ¢ç´¢å€åŸŸ (æœ€è¿‘ 5 ç­†ç´€éŒ„)</label>
                    <div class="flex gap-2">
                        <input type="text" id="distInput" placeholder="æœå°‹å…¨å°è¡Œæ”¿å€..." class="input-style flex-1" onfocus="showDists()" oninput="filterDists()">
                        <button onclick="useMyLocation()" class="bg-[var(--morandi-pink)] text-white px-4 rounded-2xl text-[10px] font-bold shadow-md active:scale-90 transition-all">ğŸ“å®šä½</button>
                    </div>
                    <div id="distResults" class="search-results"></div>
                    <div id="chipContainer" class="flex flex-wrap mt-2"></div>
                </div>

                <div class="space-y-3">
                    <label class="font-bold text-xs text-[var(--morandi-coffee)] px-1 tracking-widest uppercase">é ç®—å€é–“ (è¤‡é¸)</label>
                    <div class="grid grid-cols-4 gap-3">
                        <div class="price-box active" data-val="1" onclick="togglePrice(this, 1)"><span class="font-bold text-sm">$</span><span class="text-[8px] opacity-70">$200â†“</span></div>
                        <div class="price-box active" data-val="2" onclick="togglePrice(this, 2)"><span class="font-bold text-sm">$$</span><span class="text-[8px] opacity-70">$200-600</span></div>
                        <div class="price-box active" data-val="3" onclick="togglePrice(this, 3)"><span class="font-bold text-sm">$$$</span><span class="text-[8px] opacity-70">$600-1200</span></div>
                        <div class="price-box active" data-val="4" onclick="togglePrice(this, 4)"><span class="font-bold text-sm">$$$$</span><span class="text-[8px] opacity-70">$1200â†‘</span></div>
                    </div>
                </div>

                <div class="space-y-3">
                    <label class="font-bold text-xs text-[var(--morandi-coffee)] block px-1 tracking-widest uppercase">ç¾é£Ÿé¡åˆ¥ (è¤‡é¸)</label>
                    <div class="grid grid-cols-3 gap-3" id="catGrid"></div>
                </div>

                <button onclick="fetchRealData()" class="w-full bg-[var(--morandi-slate)] text-white font-bold py-5 rounded-[2rem] shadow-lg active:scale-95 transition-all tracking-[0.5em] text-sm">å±•é–‹é©šå–œé£Ÿå…‰</button>

                <div class="p-6 bg-gray-50/50 rounded-[2.5rem] text-center space-y-3">
                    <label class="font-bold text-xs text-gray-400 block tracking-widest uppercase">æ–°å¢ç§è—åº—å®¶</label>
                    <input type="text" id="newUrl" placeholder="è²¼ä¸Š Google Map ç¶²å€è§£æåç¨±" class="input-style bg-white text-[10px]" oninput="autoDetectName(this.value)">
                    <input type="text" id="newName" placeholder="åº—å®¶åç¨±" class="input-style bg-white text-xs">
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <select id="newCat" class="input-style bg-white text-xs py-3"></select>
                        <select id="newPrice" class="input-style bg-white text-xs py-3">
                            <option value="1">$ 200â†“</option><option value="2" selected>$$ 200-600</option><option value="3">$$$ 600-1200</option><option value="4">$$$$ 1200â†‘</option>
                        </select>
                    </div>
                    <button onclick="saveMyStore()" class="w-full bg-[var(--morandi-pink)] text-white py-4 rounded-2xl text-xs font-bold shadow-md active:scale-95 transition-all">å­˜å…¥å£è¢‹åå–®</button>
                </div>
            </div>
        </div>

        <div id="resultPage" class="page hidden-page bg-[var(--morandi-bg)]">
            <header class="flex justify-between items-center py-8 px-2 sticky top-0 bg-[var(--morandi-bg)] z-10">
                <button onclick="goToFilter()" class="text-[var(--morandi-slate)] text-sm font-bold">â† ä¿®æ”¹æ¢ä»¶</button>
                <h2 class="text-lg font-bold text-[var(--morandi-coffee)] tracking-widest">æ¢ç´¢çµæœ</h2>
                <button onclick="shuffleAndRender()" class="text-[var(--morandi-pink)] text-sm font-bold">ğŸ² æ›ä¸€æ‰¹</button>
            </header>
            <div id="loadingArea" class="hidden text-center py-20"></div>
            <div id="resultsList" class="pb-24 px-2"></div>
        </div>

        <div id="pocketPage" class="page hidden-page bg-[var(--morandi-bg)]">
            <header class="flex justify-between items-center py-8 px-2 sticky top-0 bg-[var(--morandi-bg)] z-10">
                <button onclick="goToFilter()" class="text-[var(--morandi-slate)] text-sm font-bold">â† è¿”å›</button>
                <h2 class="text-lg font-bold text-[var(--morandi-pink)] tracking-widest">æˆ‘çš„æ”¶è—</h2>
                <button onclick="openBackupModal()" class="bg-white p-2 rounded-full shadow-sm text-xs">â˜ï¸ å‚™ä»½</button>
            </header>
            <div id="pocketList" class="pb-24 px-2"></div>
        </div>
    </div>

    <div id="editModal"><div class="bg-white rounded-[3rem] p-10 w-11/12 max-sm space-y-5 shadow-2xl">
        <h3 class="text-center font-bold text-[var(--morandi-coffee)] tracking-widest uppercase">ç·¨è¼¯åº—å®¶è³‡è¨Š</h3>
        <input type="text" id="editName" class="input-style bg-gray-50 text-xs">
        <input type="text" id="editAddr" class="input-style bg-gray-50 text-xs">
        <div class="grid grid-cols-2 gap-3"><select id="editCat" class="input-style bg-gray-50 text-xs py-3"></select><select id="editPrice" class="input-style bg-gray-50 text-xs py-3"><option value="1">$ 200â†“</option><option value="2">$$ 200-600</option><option value="3">$$$ 600-1200</option><option value="4">$$$$ 1200â†‘</option></select></div>
        <button onclick="commitEdit()" class="w-full py-4 bg-[var(--morandi-slate)] text-white rounded-2xl text-xs font-bold shadow-md">å„²å­˜ä¿®æ”¹</button>
        <button onclick="closeEditModal()" class="w-full py-2 text-gray-300 text-[10px]">å–æ¶ˆ</button>
    </div></div>

    <div id="backupModal"><div class="bg-white rounded-[3rem] p-10 w-11/12 max-sm space-y-5 shadow-2xl">
        <h3 class="text-center font-bold text-[var(--morandi-coffee)] tracking-widest uppercase">æ•¸æ“šå‚™ä»½</h3>
        <textarea id="backupData" class="w-full h-32 p-4 text-[10px] bg-gray-50 border-none rounded-2xl outline-none" readonly></textarea>
        <button onclick="copyBackup()" class="w-full py-4 bg-[var(--morandi-slate)] text-white rounded-2xl text-xs font-bold shadow-md">è¤‡è£½ä»£ç¢¼</button>
        <button onclick="importBackup()" class="w-full py-3 text-[var(--morandi-slate)] font-bold text-sm">åŒ¯å…¥é‚„åŸ</button>
        <button onclick="closeBackupModal()" class="w-full py-2 text-gray-300 text-[10px]">é—œé–‰</button>
    </div></div>

    <script>
        const DB = {"åŸºéš†å¸‚":["ä»æ„›å€","ä¿¡ç¾©å€","ä¸­æ­£å€","ä¸­å±±å€","å®‰æ¨‚å€","æš–æš–å€","ä¸ƒå µå€"],"å°åŒ—å¸‚":["ä¸­æ­£å€","è¬è¯å€","å¤§åŒå€","ä¸­å±±å€","æ¾å±±å€","å¤§å®‰å€","ä¿¡ç¾©å€","å…§æ¹–å€","å—æ¸¯å€","å£«æ—å€","åŒ—æŠ•å€","æ–‡å±±å€"],"æ–°åŒ—å¸‚":["æ¿æ©‹å€","ä¸‰é‡å€","ä¸­å’Œå€","æ°¸å’Œå€","æ–°èŠå€","æ–°åº—å€","åœŸåŸå€","è˜†æ´²å€","æ¨¹æ—å€","æ±æ­¢å€","ä¸‰å³½å€","æ·¡æ°´å€","é¶¯æ­Œå€","äº”è‚¡å€","æ³°å±±å€","æ—å£å€","æ·±å‘å€","çŸ³ç¢‡å€","åªæ—å€","ä¸‰èŠå€","çŸ³é–€å€","å…«é‡Œå€","å¹³æºªå€","é›™æºªå€","è²¢å¯®å€","è¬é‡Œå€","é‡‘å±±å€","ç‘èŠ³å€","çƒä¾†å€"],"æ¡ƒåœ’å¸‚":["æ¡ƒåœ’å€","ä¸­å£¢å€","å¹³é®å€","å…«å¾·å€","æ¥Šæ¢…å€","è˜†ç«¹å€","å¤§æºªå€","é¾æ½­å€","å¤§åœ’å€","é¾œå±±å€","è§€éŸ³å€","æ–°å±‹å€","å¾©èˆˆå€"],"æ–°ç«¹å¸‚":["æ±å€","åŒ—å€","é¦™å±±å€"],"æ–°ç«¹ç¸£":["ç«¹åŒ—å¸‚","ç«¹æ±é®","æ–°åŸ”é®","é—œè¥¿é®","æ¹–å£é„‰","æ–°è±é„‰","èŠæ—é„‰","æ©«å±±é„‰","åŒ—åŸ”é„‰","å¯¶å±±é„‰","å³¨çœ‰é„‰","å°–çŸ³é„‰","äº”å³°é„‰"],"è‹—æ —ç¸£":["è‹—æ —å¸‚","é ­ä»½å¸‚","ç«¹å—é®","å¾Œé¾é®","é€šéœ„é®","è‹‘è£¡é®","å“è˜­é®","é€ æ©‹é„‰","è¥¿æ¹–é„‰","é ­å±‹é„‰","å…¬é¤¨é„‰","éŠ…é‘¼é„‰","ä¸‰ç¾©é„‰","å¤§æ¹–é„‰","ç…æ½­é„‰","ä¸‰ç£é„‰","å—åº„é„‰","æ³°å®‰é„‰"],"å°ä¸­å¸‚":["ä¸­å€","æ±å€","å—å€","è¥¿å€","åŒ—å€","åŒ—å±¯å€","è¥¿å±¯å€","å—å±¯å€","å¤ªå¹³å€","å¤§é‡Œå€","éœ§å³°å€","çƒæ—¥å€","è±åŸå€","åé‡Œå€","çŸ³å²¡å€","æ±å‹¢å€","æ–°ç¤¾å€","æ½­å­å€","å¤§é›…å€","ç¥å²¡å€","å¤§ç”²å€","æ¸…æ°´å€","æ²™é¹¿å€","å¤§è‚šå€","é¾äº•å€","æ¢§æ£²å€","å’Œå¹³å€"],"å½°åŒ–ç¸£":["å½°åŒ–å¸‚","å“¡æ—å¸‚","å’Œç¾é®","é¹¿æ¸¯é®","æºªæ¹–é®","äºŒæ—é®","ç”°ä¸­é®","åŒ—æ–—é®","èŠ±å£‡é„‰","èŠ¬åœ’é„‰","å¤§æ‘é„‰","æ°¸é–é„‰","ä¼¸æ¸¯é„‰","ç·šè¥¿é„‰","ç¦èˆˆé„‰","ç§€æ°´é„‰","åŸ”å¿ƒé„‰","åŸ”é¹½é„‰","å¤§åŸé„‰","èŠ³è‹‘é„‰","ç«¹å¡˜é„‰","ç¤¾é ­é„‰","äºŒæ°´é„‰","ç”°å°¾é„‰","åŸ¤é ­é„‰","æºªå·é„‰"],"å—æŠ•ç¸£":["å—æŠ•å¸‚","åŸ”é‡Œé®","è‰å±¯é®","ç«¹å±±é®","é›†é›†é®","åé–“é„‰","é¹¿è°·é„‰","ä¸­å¯®é„‰","é­šæ± é„‰","åœ‹å§“é„‰","æ°´é‡Œé„‰","ä¿¡ç¾©é„‰","ä»æ„›é„‰"],"é›²æ—ç¸£":["æ–—å…­å¸‚","æ–—å—é®","è™å°¾é®","è¥¿èºé®","åœŸåº«é®","åŒ—æ¸¯é®","å¤å‘é„‰","å¤§åŸ¤é„‰","è¿æ¡é„‰","æ—å…§é„‰","äºŒå´™é„‰","å´™èƒŒé„‰","éº¥å¯®é„‰","æ±å‹¢é„‰","è¤’å¿ é„‰","å°è¥¿é„‰","å…ƒé•·é„‰","å››æ¹–é„‰","å£æ¹–é„‰","æ°´æ—é„‰"],"å˜‰ç¾©å¸‚":["æ±å€","è¥¿å€"],"å˜‰ç¾©ç¸£":["å¤ªä¿å¸‚","æœ´å­å¸‚","å¸ƒè¢‹é®","å¤§æ—é®","æ°‘é›„é„‰","æºªå£é„‰","æ–°æ¸¯é„‰","å…­è…³é„‰","æ±çŸ³é„‰","ç¾©ç«¹é„‰","é¹¿è‰é„‰","æ°´ä¸Šé„‰","ä¸­åŸ”é„‰","ç«¹å´é„‰","æ¢…å±±é„‰","ç•ªè·¯é„‰","å¤§åŸ”é„‰","é˜¿é‡Œå±±é„‰"],"å°å—å¸‚":["ä¸­è¥¿å€","æ±å€","å—å€","åŒ—å€","å®‰å¹³å€","å®‰å—å€","æ°¸åº·å€","æ­¸ä»å€","æ–°åŒ–å€","å·¦é®å€","ç‰äº•å€","æ¥ è¥¿å€","å—åŒ–å€","ä»å¾·å€","é—œå»Ÿå€","é¾å´å€","å®˜ç”°å€","éº»è±†å€","ä½³é‡Œå€","è¥¿æ¸¯å€","ä¸ƒè‚¡å€","å°‡è»å€","å­¸ç”²å€","åŒ—é–€å€","æ–°ç‡Ÿå€","å¾Œå£å€","ç™½æ²³å€","æ±å±±å€","å…­ç”²å€","ä¸‹ç‡Ÿå€","æŸ³ç‡Ÿå€","å–„åŒ–å€","å¤§å…§å€","å±±ä¸Šå€","æ–°å¸‚å€","å®‰å®šå€","é¹½æ°´å€"],"é«˜é›„å¸‚":["æ–°èˆˆå€","å‰é‡‘å€","è‹“é›…å€","é¹½åŸ•å€","é¼“å±±å€","æ——æ´¥å€","å‰é®å€","ä¸‰æ°‘å€","æ¥ æ¢“å€","å°æ¸¯å€","å·¦ç‡Ÿå€","ä»æ­¦å€","å¤§ç¤¾å€","å²¡å±±å€","è·¯ç«¹å€","é˜¿è“®å€","ç”°å¯®å€","ç‡•å·¢å€","æ©‹é ­å€","æ¢“å®˜å€","å½Œé™€å€","æ°¸å®‰å€","æ¹–å…§å€","é³³å±±å€","å¤§å¯®å€","æ—åœ’å€","é³¥æ¾å€","å¤§æ¨¹å€","æ——å±±å€","ç¾æ¿ƒå€","å…­é¾œå€","å…§é–€å€","æ‰æ—å€","ç”²ä»™å€","æ¡ƒæºå€","é‚£ç‘ªå¤å€","èŒ‚æ—å€","èŒ„è£å€"],"å±æ±ç¸£":["å±æ±å¸‚","æ½®å·é®","æ±æ¸¯é®","æ†æ˜¥é®","è¬ä¸¹é„‰","é•·æ²»é„‰","éºŸæ´›é„‰","ä¹å¦‚é„‰","é‡Œæ¸¯é„‰","é«˜æ¨¹é„‰","é¹½åŸ”é„‰","å…§åŸ”é„‰","ç«¹ç”°é„‰","æ–°åŸ¤é„‰","æ‹å¯®é„‰","æ–°åœ’é„‰","å´é ‚é„‰","æ—é‚Šé„‰","å—å·é„‰","ä½³å†¬é„‰","ç‘ç©—é„‰","ç‰çƒé„‰","è»ŠåŸé„‰","æ»¿å·é„‰","æ‹å±±é„‰","æ˜¥æ—¥é„‰","ç…å­é„‰","ç‰¡ä¸¹é„‰","è¬å·’é„‰"],"å®œè˜­ç¸£":["å®œè˜­å¸‚","ç¾…æ±é®","è˜‡æ¾³é®","é ­åŸé®","ç¤æºªé„‰","å£¯åœé„‰","å“¡å±±é„‰","å†¬å±±é„‰","äº”çµé„‰","ä¸‰æ˜Ÿé„‰","å¤§åŒé„‰","å—æ¾³é„‰"],"èŠ±è“®ç¸£":["èŠ±è“®å¸‚","é³³æ—é®","ç‰é‡Œé®","æ–°åŸé„‰","å‰å®‰é„‰","å£½è±é„‰","å…‰å¾©é„‰","è±æ¿±é„‰","ç‘ç©—é„‰","å¯Œé‡Œé„‰","ç§€æ—é„‰","è¬æ¦®é„‰","å“æºªé„‰"],"å°æ±ç¸£":["å°æ±å¸‚","æˆåŠŸé®","é—œå±±é®","å‘å—é„‰","é¹¿é‡é„‰","æ± ä¸Šé„‰","æ±æ²³é„‰","é•·æ¿±é„‰","å¤ªéº»é‡Œé„‰","å¤§æ­¦é„‰","ç¶ å³¶é„‰","è˜­å¶¼é„‰","æµ·ç«¯é„‰","å»¶å¹³é„‰","é‡‘å³°é„‰","é”ä»é„‰"],"æ¾æ¹–ç¸£":["é¦¬å…¬å¸‚","æ¹–è¥¿é„‰","ç™½æ²™é„‰","è¥¿å¶¼é„‰","æœ›å®‰é„‰","ä¸ƒç¾é„‰"],"é‡‘é–€ç¸£":["é‡‘åŸé®","é‡‘æ¹–é®","é‡‘æ²™é®","é‡‘å¯§é„‰","çƒˆå¶¼é„‰","çƒåµé„‰"],"é€£æ±Ÿç¸£":["å—ç«¿é„‰","åŒ—ç«¿é„‰","è’å…‰é„‰","æ±å¼•é„‰"]};
        const allDistNames = []; for (const city in DB) { DB[city].forEach(d => allDistNames.push(`${city} ${d}`)); }
        const cats = ["ç¾©å¼", "æ—¥å¼", "é‹ç‰©/ç‡’è‚‰", "å°åƒ", "æ—©åˆé¤", "å’–å•¡å»³"];
        
        // --- ä¿®æ­£é‡é» 1ï¼šç²¾æº–åˆ†é¡æ­£å‰‡ (ç¾©å¼ç‰›æ’ã€é£²æ–™å°åƒã€è±†èŠ±åˆ†æµ) ---
        const FUZZY_DICT = { 
            "ç¾©å¼": /ç¾©å¼|Pasta|Pizza|æŠ«è–©|ç¾©å¤§åˆ©|Skylark|èŠ³é„°|èŒ¹çµ²è‘µ|å¦‚çµ²è‘µ|å¤æ…•å°¼|è¥¿å ¤|å°ç¾©å¤§åˆ©|æ³•å¼|å¾·å¼|æ­å¼|æ­é™¸|è¥¿å¼|å¾·å¥§|é¤å»³|å°é¤¨|è¥¿é¤|ç¾å¼|ç“¦åŸ|1010æ¹˜/i, 
            "æ—¥å¼": /æ—¥å¼|å£½å¸|æ‹‰éºµ|å’Œé£Ÿ|å±…é…’å±‹|å®šé£Ÿ|ç¦å‹äº­|å‰é‡å®¶|ç‰§å ´|ä¸¼|æ—¥æœ¬æ–™ç†|åˆºèº«|å’Œé¢¨/i, 
            "é‹ç‰©/ç‡’è‚‰": /ç«é‹|é‹ç‰©|ç‡’è‚‰|çƒ¤è‚‰|ç‡’çƒ¤|æ¶®æ¶®é‹|å’Œç‰›|æ¶®|å£½å–œç‡’|é‹/i, 
            "æ—©åˆé¤": /æ—©åˆé¤|æ—©é»|æ—©é¤|Brunch|Breakfast|ç¾è€Œç¾|å¼˜çˆº|ç‘éºŸ|éº¥å‘³ç™»|ç¾èŠåŸ|æ‹‰äº|æ—©å®‰|æ¼¢å ¡|åå¸|ä¸‰æ˜æ²»|é˜¿å¯¶/i, 
            "å’–å•¡å»³": /å’–å•¡|Cafe|ä¸‹åˆèŒ¶|ç”œé»|éºµåŒ…|çƒ˜ç„™/i, 
            "å°åƒ": /å°åƒ|éºµåº—|æ»·è‚‰|ä¾¿ç•¶|æ»·å‘³|é£Ÿå ‚|æµ·é®®|è‚‰èˆ–|èŒ¶æ¹¯æœƒ|city milk|é£²æ–™|æ‰‹æ–|ç‰›å¥¶|è±†èŠ±|çµ±å…ƒ|æ°´é¤ƒ|äºæ´²|å°åº¦|å—æ´‹|æ–™ç†|è‚‰åœ“|å¤æ—©å‘³/i 
        };
        const foodKeywords = /åº—|é¤¨|å»³|åŠ|å®¶|è¡—|å ´|é‹ª|åº§|å§|é£Ÿ|é£²|éºµ|é£¯|æ¹¯|é‹|ç‡’|çƒ¤|æ—©|åˆ|ç‚¸|å†°|ç”œ|è‚‰|èœ|é­š|é›|æ‹‰éºµ|æ¼¢å ¡|å£½å¸|éºµåŒ…|æŠ«è–©|äº­|å‹|å®š|é£Ÿ|ä¸¼|å’–|å“©|éº¥|å‹|è‚¯|å¾·|åŸº|æ‘©|æ–¯|ç‹|æ˜Ÿ|å·´|å…‹|é£Ÿå ‚|æµ·é®®|è‚‰èˆ–|æ–™ç†|è±†èŠ±|ç‰›æ’/;
        const excludeKeywords = /äº”é‡‘|è—¥å±€|è—¥å¦|ç”Ÿæ´»é¤¨|é€šè¨Š|æ°´é›»|å°åˆ·|çœ¼é¡|è¨ºæ‰€|æ©Ÿè»Š|åœ–æ›¸é¤¨|ä¿®è»Š/;

        let selectedSet = new Set(); let selectedPrices = new Set([1, 2, 3, 4]); 
        let shuffledQueue = []; let queueIndex = 0; let currentEditIndex = -1;

        // --- ä¿®æ­£é‡é» 2ï¼šç©©å®šå°èˆª (å¾¹åº•è§£æ±º 404) ---
        function getStableMapUrl(name) {
            return "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(name);
        }

        // è¡Œæ”¿å€
        function showDists() {
            const res = document.getElementById('distResults'); const history = JSON.parse(localStorage.getItem('SEARCH_HISTORY_V15') || "[]");
            if (history.length > 0) { res.innerHTML = `<div class="recent-label">æœ€è¿‘æœå°‹</div>` + history.map(d => `<div class="search-item" onclick="selectSearch('${d}')">${d}</div>`).join(''); res.style.display = 'block'; }
            else { res.style.display = 'none'; }
        }
        function selectSearch(d) { selectedSet.delete("ğŸ“ ç›®å‰ä½ç½®"); selectedSet.add(d); let h = JSON.parse(localStorage.getItem('SEARCH_HISTORY_V15') || "[]"); h = [d, ...h.filter(i => i !== d)].slice(0, 5); localStorage.setItem('SEARCH_HISTORY_V15', JSON.stringify(h)); document.getElementById('distInput').value = ''; document.getElementById('distResults').style.display = 'none'; renderChips(); }
        function filterDists() { const v = document.getElementById('distInput').value; const r = document.getElementById('distResults'); if(!v) { showDists(); return; } const f = allDistNames.filter(d => d.includes(v)).slice(0, 15); r.innerHTML = f.map(d => `<div class="search-item" onclick="selectSearch('${d}')">${d}</div>`).join(''); r.style.display = 'block'; }
        function renderChips() { document.getElementById('chipContainer').innerHTML = Array.from(selectedSet).map(d => `<div class="selected-chip">${d}<span onclick="removeChip('${d}')"> Ã—</span></div>`).join(''); }
        function removeChip(d) { selectedSet.delete(d); renderChips(); }
        function useMyLocation() { selectedSet.clear(); selectedSet.add("ğŸ“ ç›®å‰ä½ç½®"); renderChips(); }

        async function getCoord(d) {
            if (d === "ğŸ“ ç›®å‰ä½ç½®") return new Promise((res, rej) => navigator.geolocation.getCurrentPosition(p => res({lat: p.coords.latitude, lon: p.coords.longitude}), e => rej("å®šä½å¤±æ•—"), {timeout: 5000}));
            let cache = JSON.parse(localStorage.getItem('GEO_CACHE_V_FINAL') || "{}"); if (cache[d]) return cache[d];
            const r = await fetch("https://nominatim.openstreetmap.org/search?format=json&q=" + encodeURIComponent(d + " å°ç£") + "&limit=1");
            const data = await r.json(); if (data[0]) { const res = { lat: data[0].lat, lon: data[0].lon }; cache[d] = res; localStorage.setItem('GEO_CACHE_V_FINAL', JSON.stringify(cache)); return res; }
            return null;
        }

        // --- æ ¸å¿ƒé‚è¼¯ï¼šå“ç‰Œæ””æˆªå„ªå…ˆ + KwMaKzz æ’åº ---
        async function fetchRealData() {
            if (selectedSet.size === 0) return alert("è«‹å…ˆé¸å–å€åŸŸ");
            document.getElementById('filterPage').classList.add('hidden-page'); document.getElementById('resultPage').classList.remove('hidden-page');
            document.getElementById('loadingArea').classList.remove('hidden');
            document.getElementById('loadingArea').innerHTML = `<div class="loader"></div><p class="text-[11px] text-gray-400 tracking-[0.2em] uppercase">æ­£åœ¨å°‹è¦“ç¾å‘³è¹¤è·¡</p>`;
            document.getElementById('resultsList').innerHTML = "";
            try {
                const coords = (await Promise.all(Array.from(selectedSet).map(async d => { try { return await getCoord(d); } catch(e) { return null; } }))).filter(c => c !== null);
                const selectedCatTags = Array.from(document.querySelectorAll('#catGrid input:checked')).map(el => el.value);
                const nameMap = new Set();
                
                // ç§è—å„ªå…ˆ (KwMaKzz éš¨æ©Ÿç­–ç•¥)
                let myStores = JSON.parse(localStorage.getItem('muo_stores') || "[]").filter(s => {
                    const kw = Array.from(selectedSet).map(d => d.includes("ç›®å‰ä½ç½®") ? "" : d.split(' ')[1] || d).filter(v => v !== "");
                    const distMatch = selectedSet.has("ğŸ“ ç›®å‰ä½ç½®") || kw.some(k => (s.dist || "").includes(k) || (s.address || "").includes(k));
                    return distMatch && (selectedCatTags.length === 0 || selectedCatTags.some(tc => s.cat === tc || FUZZY_DICT[tc].test(s.name))) && selectedPrices.has(s.priceVal);
                }).map(s => { nameMap.add(s.name); return {...s, isPrivate: true, score: Math.random() + 10}; });

                let unionQuery = coords.map(l => `nwr["amenity"~"restaurant|fast_food|cafe|food_court|ice_cream|bar|pub|biergarten|canteen|bbq"](around:5000,${l.lat},${l.lon});nwr["shop"~"bakery|deli|confectionery|pastry|beverages|seafood|wine|chocolate|cheese"](around:5000,${l.lat},${l.lon});nwr["craft"~"brewery|distillery"](around:5000,${l.lat},${l.lon});`).join('');
                const osmRes = await fetch("https://overpass-api.de/api/interpreter", { method: "POST", body: "data=[out:json][timeout:90];(" + unionQuery + ");out tags;" });
                const osmData = await osmRes.json();
                
                let osmShops = osmData.elements.filter(e => e.tags && e.tags.name).map(e => {
                    let n = e.tags.name; if (nameMap.has(n)) return null; if (excludeKeywords.test(n)) return null;
                    const reliableTags = ["restaurant", "fast_food", "cafe", "food_court", "ice_cream", "bar", "pub", "biergarten", "bakery", "deli", "confectionery", "pastry", "beverages", "canteen", "bbq", "seafood", "wine", "chocolate", "cheese", "brewery", "distillery"];
                    if (!reliableTags.includes(e.tags.amenity) && !reliableTags.includes(e.tags.shop) && !reliableTags.includes(e.tags.craft) && !foodKeywords.test(n)) return null; 

                    let c = null;
                    const a = e.tags.amenity; const s = e.tags.shop;
                    
                    // --- ä¿®æ­£é‡é» 3ï¼šå„ªå…ˆæƒæåº—å (è§£æ±ºç¾©å¼ã€éš¨ä¾¿ã€èŒ¶æ¹¯æœƒã€å¦‚çµ²è‘µå•é¡Œ) ---
                    for(let k of ["ç¾©å¼", "æ—¥å¼", "é‹ç‰©/ç‡’è‚‰", "æ—©åˆé¤", "å°åƒ", "å’–å•¡å»³"]) {
                        if(FUZZY_DICT[k].test(n)) { c = k; break; }
                    }

                    if (!c) {
                        const isCafeSet = ['cafe','bakery','pastry','confectionery','chocolate','ice_cream','cheese'].includes(a) || ['bakery','confectionery','pastry','chocolate','cheese'].includes(s);
                        if (isCafeSet) c = "å’–å•¡å»³";
                        else if (a === 'bbq') c = "é‹ç‰©/ç‡’è‚‰";
                        else if (['fast_food','beverages','canteen','deli','seafood','food_court','bar','pub','biergarten','brewery','distillery','wine'].includes(a) || ['beverages','seafood','deli','wine'].includes(s)) c = "å°åƒ";
                    }

                    return { name: n, address: (e.tags["addr:street"] ? e.tags["addr:city"] + e.tags["addr:district"] + e.tags["addr:street"] : "é™„è¿‘ç¯„åœ"), cat: c || "å°åƒ", priceVal: 2, isPrivate: false, score: Math.random(), dist: Array.from(selectedSet)[0] };
                }).filter(s => s !== null && (selectedCatTags.length === 0 || selectedCatTags.includes(s.cat)) && selectedPrices.has(s.priceVal));

                // æ’åºä¸¦é‡ç½®ç´¢å¼•
                shuffledQueue = [...myStores, ...osmShops].sort((a, b) => b.score - a.score);
                queueIndex = 0; document.getElementById('loadingArea').classList.add('hidden'); shuffleAndRender();
            } catch (e) { document.getElementById('loadingArea').classList.add('hidden'); alert("é€£ç·šç¹å¿™"); }
        }

        // --- ä¿®æ­£é‡é» 4ï¼šåˆ†é ä¾åºæ¸²æŸ“ (çµ•å°ä¸é‡è¤‡) ---
        function shuffleAndRender() {
            const list = document.getElementById('resultsList');
            const pLabels = ["", "$", "$$", "$$$", "$$$$"];
            
            // å¦‚æœéšŠåˆ—çµæŸï¼Œå‰‡å¾ªç’°
            if (queueIndex >= shuffledQueue.length) { 
                shuffledQueue.forEach(s => s.score = s.isPrivate ? Math.random() + 10 : Math.random());
                shuffledQueue.sort((a, b) => b.score - a.score); queueIndex = 0; 
            }
            
            let selection = shuffledQueue.slice(queueIndex, queueIndex + 20);
            list.innerHTML = selection.map(shop => `<div class="shop-card"><div class="flex justify-between items-start mb-2"><div class="pr-4 flex-1">
                <h3 class="font-bold text-[17px] mb-2 ${shop.isPrivate ? 'text-[var(--morandi-pink)]' : 'text-[var(--morandi-coffee)]'}">${shop.name}</h3>
                <div class="cat-tag">${shop.cat}</div></div><div class="flex flex-col items-end min-w-[70px]"><span class="price-text">${pLabels[shop.priceVal]}</span></div></div>
                <p class="text-[11px] text-gray-400 mb-6">ğŸ“ ${shop.address}</p><div class="flex justify-end gap-3">
                ${shop.isPrivate ? `<button onclick="deleteStore('${shop.name.replace(/'/g, "\\'")}', '${shop.dist}')" class="text-red-300 text-[10px] font-bold px-4 py-2 mr-auto">åˆªé™¤</button>` : ''}
                <button onclick="window.open('https://www.google.com/search?q=' + encodeURIComponent('${shop.name.replace(/'/g, "\\'")}'))" class="text-[var(--morandi-slate)] border border-[var(--morandi-slate)] px-5 py-2.5 rounded-xl text-[10px] font-bold">é£Ÿè¨˜</button>
                <button onclick="window.open('${getStableMapUrl(shop.name)}')" class="bg-[var(--morandi-slate)] text-white px-6 py-2.5 rounded-xl text-[10px] font-bold shadow-md">å°èˆª</button></div></div>`).join('');
            
            queueIndex += 20; window.scrollTo(0,0);
        }

        // å£è¢‹åå–®å…¨åŸŸé‡è¤‡æ””æˆª
        function saveMyStore() {
            const n = document.getElementById('newName').value.trim(); const d = Array.from(selectedSet)[0] || "è‡ªè¨‚å€åŸŸ"; 
            if (!n) return alert("è«‹è¼¸å…¥åº—å");
            let m = JSON.parse(localStorage.getItem('muo_stores') || "[]"); 
            if (m.some(s => s.name === n)) {
                if (!confirm("ã€Œ" + n + "ã€å·²åœ¨æ¸…å–®ä¸­ï¼Œæ˜¯å¦è¦†è“‹è³‡è¨Šï¼Ÿ")) return;
                m = m.filter(s => s.name !== n);
            }
            m.push({ name: n, cat: document.getElementById('newCat').value, priceVal: parseInt(document.getElementById('newPrice').value), dist: d, address: d, isPrivate: true });
            localStorage.setItem('muo_stores', JSON.stringify(m)); alert("âœ… æˆåŠŸï¼"); document.getElementById('newName').value = ""; document.getElementById('newUrl').value = "";
        }

        // é é¢æ§åˆ¶èˆ‡å…¶é¤˜åŠŸèƒ½
        function togglePrice(el, v) { if (selectedPrices.has(v)) { if (selectedPrices.size > 1) { selectedPrices.delete(v); el.classList.remove('active'); } } else { selectedPrices.add(v); el.classList.add('active'); } }
        function goToFilter() { document.querySelectorAll('.page').forEach(p => p.classList.add('hidden-page')); document.getElementById('filterPage').classList.remove('hidden-page'); window.scrollTo(0, 0); }
        function goToPocket() { document.querySelectorAll('.page').forEach(p => p.classList.add('hidden-page')); document.getElementById('pocketPage').classList.remove('hidden-page'); renderPocketList(); }
        function renderPocketList() {
            const list = document.getElementById('pocketList'); const m = JSON.parse(localStorage.getItem('muo_stores') || "[]");
            list.innerHTML = m.map((s, i) => `<div class="shop-card"><div class="flex justify-between items-start mb-2"><div class="pr-4 flex-1"><h3 class="font-bold text-[17px] text-[var(--morandi-pink)] mb-2">${s.name}</h3><div class="cat-tag" style="color:var(--morandi-pink); background:#FEF5F4;">${s.cat}</div></div><div class="flex flex-col items-end min-w-[70px]"><span class="price-text">${["","$","$$","$$$","$$$$"][s.priceVal]}</span></div></div><p class="text-[11px] text-gray-400 mb-6">ğŸ“ ${s.address}</p><div class="flex justify-end gap-3"><button onclick="deleteStore('${s.name.replace(/'/g, "\\'")}', '${s.dist}', true)" class="text-red-300 text-[10px] font-bold px-4 py-2 mr-auto">åˆªé™¤</button><button onclick="editStore(${i})" class="text-[var(--morandi-slate)] border border-[var(--morandi-slate)] px-5 py-2.5 rounded-xl text-[10px] font-bold">ç·¨è¼¯</button><button onclick="window.open('${getStableMapUrl(s.name)}')" class="bg-[var(--morandi-slate)] text-white px-6 py-2.5 rounded-xl text-[10px] font-bold shadow-md">å°èˆª</button></div></div>`).join('');
        }
        function deleteStore(n, d, f) { if (confirm("åˆªé™¤ï¼Ÿ")) { let m = JSON.parse(localStorage.getItem('muo_stores')); localStorage.setItem('muo_stores', JSON.stringify(m.filter(s => !(s.name === n && s.dist === d)))); if (f) renderPocketList(); else fetchRealData(); } }
        function editStore(i) { currentEditIndex = i; const m = JSON.parse(localStorage.getItem('muo_stores') || "[]"); const s = m[i]; document.getElementById('editName').value = s.name; document.getElementById('editAddr').value = s.address; document.getElementById('editCat').value = s.cat; document.getElementById('editPrice').value = s.priceVal; document.getElementById('editModal').style.display = 'flex'; }
        function closeEditModal() { document.getElementById('editModal').style.display = 'none'; }
        function commitEdit() { let m = JSON.parse(localStorage.getItem('muo_stores') || "[]"); m[currentEditIndex].name = document.getElementById('editName').value; m[currentEditIndex].address = document.getElementById('editAddr').value; m[currentEditIndex].cat = document.getElementById('editCat').value; m[currentEditIndex].priceVal = parseInt(document.getElementById('editPrice').value); localStorage.setItem('muo_stores', JSON.stringify(m)); alert("âœ… æˆåŠŸï¼"); closeEditModal(); renderPocketList(); }
        function openBackupModal() { document.getElementById('backupData').value = localStorage.getItem('muo_stores') || "[]"; document.getElementById('backupModal').style.display = 'flex'; }
        function closeBackupModal() { document.getElementById('backupModal').style.display = 'none'; }
        function copyBackup() { const el = document.getElementById('backupData'); el.select(); document.execCommand('copy'); alert("è¤‡è£½æˆåŠŸï¼"); }
        function importBackup() { const code = prompt("è«‹è²¼å…¥ä»£ç¢¼ï¼š"); if (code) { try { if (Array.isArray(JSON.parse(code))) { localStorage.setItem('muo_stores', code); alert("é‚„åŸæˆåŠŸï¼"); renderPocketList(); closeBackupModal(); } } catch(e) { alert("ç„¡æ•ˆã€‚"); } } }
        function autoDetectName(url) { try { const d = decodeURIComponent(url); let m = d.match(/\/place\/([^/]+)/); if (m) { const n = m[1].replace(/\+/g, " "); document.getElementById('newName').value = n; for(let k in FUZZY_DICT) { if(FUZZY_DICT[k].test(n)) { document.getElementById('newCat').value = k; break; } } } } catch(e) {} }

        // åˆå§‹åŒ–
        document.getElementById('catGrid').innerHTML = cats.map(c => `<label><input type="checkbox" value="${c}" class="hidden peer"><div class="text-center py-4 border-none rounded-2xl text-[12px] text-gray-400 bg-white shadow-sm peer-checked:bg-[var(--morandi-pink)] peer-checked:text-white transition-all">${c}</div></label>`).join('');
        document.getElementById('newCat').innerHTML = cats.map(c => `<option value="${c}">${c}</option>`).join('');
        document.getElementById('editCat').innerHTML = cats.map(c => `<option value="${c}">${c}</option>`).join('');
        document.addEventListener('click', (e) => { if (!e.target.closest('#distInput')) document.getElementById('distResults').style.display = 'none'; });
    </script>
</body>
</html>
